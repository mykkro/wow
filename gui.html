<!DOCTYPE html>
<html>
<head>
  	<script src="js/jquery/jquery-2.0.3.min.js"></script>
  	<script src="js/jquery.svg/jquery.svg.min.js"></script>
  	<script src="js/jquery.svg/jquery.svgdom.min.js"></script>
	<script src="js/d3/d3.v3.min.js"></script>
  <script src="js/common.js"></script>
	<script>


// usage: 
// $(document).filterNode("myapp:piechart")
// --> problem je v tom, ze se to porad tvari jako jmeno myapp:piechart v namespace svg



var PieChart = require("./js/piechart")(document)
var SVG = require("./js/svghelper")(document)

var _ = require("underscore")

d3.ns.prefix.wow = wowNS

$(document).ready(function() {

	/* proc tohle nefunguje? */
	//var elements = document.getElementsByTagNameNS("http://example.org/myapp", 'piechart');

	/* this works! */
  /*
	var elements = document.getElementsByTagName("wow:piechart");

    console.log("Found elements: "+elements.length)
  */

  var widgetId = 1;

  var newWidgetId = function() {
    return "wow-widget-"+(widgetId++)
  }

  var widgets = {}

  var widget = function(type, element) {
    var id = newWidgetId()
    var group = SVG.attrs(SVG.group(), {
      "data-wow": type,
      "id": id
    })
    if(element.length) {
      // it is an array of elements!
      _.each(element, function(e) {
        group.appendChild(e)
      })
    } else {
      // it is only one element
      group.appendChild(element)
    }

    // in order to get bounding box, the node must be inserted in the DOM
    var bbox = SVG.measure(group)
    var dim = { 
        width: bbox.x+bbox.width,
        height: bbox.y+bbox.height
    }

    // add widget bounding box...
    var bbe = SVG.box(bbox)
    SVG.attr(bbe, "stroke", "blue");
    group.appendChild(bbe);   

    // add size box...
    var bbe = SVG.box(dim)
    SVG.attr(bbe, "stroke", "gray");
    group.appendChild(bbe);   

    // return widget object
    widgets[id] = {
      element: group,
      type: type,
      id: id,
      bounds: {x:bbox.x, y:bbox.y, width:bbox.width,height:bbox.height},
      dim: dim
    }
    return widgets[id]
  }

  var widgetizers = {
    pieslice: null,
    piechart: function(element) {
      /* pie chart has several slices */
      var slices = $(element).filterNode("wow:pieslice")
      slices = _.map(slices, function(s) {
        var $s = $(s)
        return {label:$s.attr("label"), value:parseFloat($s.attr("value")), color:$s.attr("color")}
      })

      /* create pie chart */
      var newElement = PieChart(slices, 50, 50, 40, 110, 10)

        return widget("piechart", newElement)

    },
    flow: function(element) {
      // children are already widgetized...
      var subwidgets = $(element).find("[data-wow]")
      var conts = []
      var x = 0
      var y = 0
      _.each(subwidgets, function(sw) {
        var grp = SVG.group()
        grp.appendChild(sw)
        grp.setAttribute("transform", "translate("+x+", "+y+")")
        // get widget based on DOM node
        var id = sw.getAttribute("id")
        // get widget based on its ID
        var widget = widgets[id]
        // do layout...
        x += widget.dim.width
        conts.push(grp)
      })
      return widget("flow", conts)
    }
  }

  var makeWidget = function(element) {
    var type = element.nodeName.split(":")[1]
    var widgetizer = widgetizers[type]
    if(widgetizer) {
      /* we can run widgetizer on an element... */
      var output = widgetizer(element)
      if(output) {        
        // replace element with output
        $(element).replaceWith(output.element)
        console.log(output)
        return output;
      }
    } else {
      console.warn("Unknown widget type: "+type)
      return null
    }
  }

  var widgetize = function(node) {
    var node = node || document
    var items = $(node).filterByPrefix("wow").reverse()
    _.each(items, makeWidget)
  }

  widgetize()

  // search for widgetized elements: $("[data-wow]")

})
	</script>
</head>
<body>

<h1>My first SVG</h1>

<svg 
    version="1.1"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:wow="http://example.org/wow"
    >
<wow:flow direction="right">
    <wow:piechart name="foo" title="Sales by Region">
      <wow:pieslice label="Northern Region" value="1.23" color="blue"/>
      <wow:pieslice label="Eastern Region" value="2.53" color="red"/>
      <wow:pieslice label="Southern Region" value="3.89" color="green"/>
      <wow:pieslice label="Western Region" value="2.04" color="yellow"/>
    </wow:piechart>

<g transform="translate(0, 160)">
    <wow:piechart name="bar" title="Sales by Region">
      <wow:pieslice label="Python" value="1.23" color="blue"/>
      <wow:pieslice label="Java" value="2.53" color="red"/>
      <wow:pieslice label="C++" value="2" color="green"/>
    </wow:piechart>
</g>

</wow:flow>
<g id="tempgroup" style="display:none;"></g>

</svg>
</body>
</html>