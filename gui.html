<!DOCTYPE html>
<html>
<head>
  	<script src="js/jquery/jquery-2.0.3.min.js"></script>
  	<script src="js/jquery.svg/jquery.svg.min.js"></script>
  	<script src="js/jquery.svg/jquery.svgdom.min.js"></script>
	<script src="js/d3/d3.v3.min.js"></script>
  <script src="js/common.js"></script>
	<script>


// usage: 
// $(document).filterNode("myapp:piechart")
// --> problem je v tom, ze se to porad tvari jako jmeno myapp:piechart v namespace svg



var PieChart = require("./js/piechart")
console.log(PieChart)

var _ = require("underscore")

d3.ns.prefix.wow = wowNS

$(document).ready(function() {

	/* proc tohle nefunguje? */
	//var elements = document.getElementsByTagNameNS("http://example.org/myapp", 'piechart');

	/* this works! */
	var elements = document.getElementsByTagName("wow:piechart");

    console.log("Found elements: "+elements.length)

	var matchingElements = [];
  ;
  for (var i = 0; i < elements.length; i++)
  {
    if (elements[i].getAttribute("name"))
    {
      // Element exists with attribute. Add to array.
      matchingElements.push(elements[i]);
    }
  }
  console.log(matchingElements);

	/* SVG "widgetization" */

	/* how to get elements myapp:something (maybe with name=?) */

	/* create svg representation of new element... */
	

	/* get the old element... */
  	var el = elements[0]
  	/* replace it */
  	//el.parentNode.replaceChild(newElement, el);


	var el = $(document).filterNode("wow:piechart")[0]
	console.log(el)

  var widgetizers = {
    pieslice: null,
    piechart: function(element) {
      /* pie chart has several slices */
      var slices = $(element).filterNode("wow:pieslice")
      slices = _.map(slices, function(s) {
        return {label:$(s).attr("label"), value:$(s).attr("value")}
      })
      console.log(slices)

      /* create pie chart */
      var newElement = PieChart(document, [13,32,53], 200, 100, 50, 50, 40, ["red","green","blue"], ["Label 1","Second","Another"], 110, 10)
      return newElement
    }
  }

  var makeWidget = function(element) {
    var type = element.nodeName.split(":")[1]
    var widgetizer = widgetizers[type]
    if(widgetizer) {
      /* we can run widgetizer on an element... */
      var output = widgetizer(element)
      if(output) {
        // replace element with output
        $(element).replaceWith(output)
      }
    } else {
      console.warn("Unknown widget type: "+type)
    }
  }

  var widgetize = function(node) {
    var node = node || document
    var items = $(node).filterByPrefix("wow").reverse()
    _.each(items, makeWidget)
  }

  widgetize()

})
	</script>
</head>
<body>

<h1>My first SVG</h1>

<svg 
  width="300" 
  height="300" 
  version="1.1"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:wow="http://example.org/wow"
    >

    <wow:piechart name="foo" title="Sales by Region">
      <wow:pieslice label="Northern Region" value="1.23"/>
      <wow:pieslice label="Eastern Region" value="2.53"/>
      <wow:pieslice label="Southern Region" value="3.89"/>
      <wow:pieslice label="Western Region" value="2.04"/>
	  <desc>This chart includes private data in another namespace
	  </desc>
      <!-- Other private data goes here -->
    </wow:piechart>
</svg>
</body>
</html>