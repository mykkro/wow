<!DOCTYPE html>
<html>
<head>
  <link href="css/normalize.css" media="all" rel="stylesheet" type="text/css" />
  <link href="css/style.css" media="all" rel="stylesheet" type="text/css" />
  <link href="fonts/SourceSansPro/fontface.css" media="all" rel="stylesheet" type="text/css" />
  <link href="fonts/Meteocons/stylesheet.css" media="all" rel="stylesheet" type="text/css" />
  <!-- third party libraries should be loaded here and then passed to the Widgetizer module... -->
  <script type="text/javascript" src="js/jquery/jquery-2.0.3.min.js"></script>
  <script type="text/javascript" src="js/jquery.svg/jquery.svg.min.js"></script>
  <script type="text/javascript" src="js/jquery.svg/jquery.svgdom.min.js"></script>
  <script type="text/javascript" src="js/svgjs/svg.min.js"></script>
  <script type="text/javascript" src="js/svgjs/svg.easing.min.js"></script>
  <script type="text/javascript" src="js/svgjs/svg.filter.js"></script>
	<script>
	var DEBUG = true
	
	// access main module...
	////process.mainModule.exports.hello()

	$(document).ready(function() {
	
		var mustache = require('mustache');
		var url = require('url')
		var path = require('path')
		var gui = require('nw.gui');


		var i18n = new (require('i18n-2'))({
		    locales: ['en', 'de', 'cz'],
		    defaultLocale: 'en'
		});

		i18n.setLocale('de')

		console.log( i18n.__("Hello!") );

		window.gui = gui

		/* loads page view and script */
		function loadPage(pageInfo, data, next) {
			var scriptName = pageInfo.script || pageInfo.view
			var pageName = pageInfo.view
			var allData = $.extend(data, pageInfo)
			console.log(allData)
		   $.get("pages/"+pageName+".wow").done(function(response) {				
				var html = mustache.to_html(response, allData);
				$('#top-wrapper').html(html);			
				var scr = require("./pages/"+scriptName+".js")(window, $, SVG, i18n)
				scr.init(allData, next)
			}).fail(function(err) {
				alert("Error loading view: "+pageName)
			})
		}
				
		/* creates link to a page */
		function getPageUrl(pageInfo) {
			// assemble URL
			return url.format({
				protocol:parsedUrl.protocol, 
				pathname:parsedUrl.pathname, 
				query: pageInfo.query, 
				hash: pageInfo.hash
			})
		}	
		
		var loc = window.location.href
		var parsedUrl = url.parse(loc, true)
		var query = parsedUrl.query
		var hash = parsedUrl.hash

		/* raw URL data */
		var pageInfo = {
			view: query.view || "homepage",
			script: query.view || "homepage",
			query: query,
			hash: hash,
			baseUrl: getPageUrl({})
		}

		console.log(getPageUrl(pageInfo))

		var previews = ["BookCategoriesPage", "BooksPage", "ButtonsPage", "HomePage", "LoginPage", "RadioPage", "VideoPage", "YouTubePage"]		
		/* Custom page data - eg. loaded from database */
		var pageData = {
		}


		var Auth = require("./lib/auth")(window)
		Auth.login("mykkro", "pass", function(err, user) {
			if(err) console.error(err)
			if(user) console.log(user)
		})

		/* Do it! */
		loadPage(pageInfo, pageData, function(ctrl) {
			console.log("Page loaded successfully!")
			console.log(pageData)
			
			// FIX to prevent backspace key from doing "go back to previous page"
			// from: http://stackoverflow.com/questions/1495219/how-can-i-prevent-the-backspace-key-from-navigating-back
			
			/*
			 * this swallows backspace keys on any non-input element.
			 * stops backspace -> back
			 */
			var rx = /INPUT|SELECT|TEXTAREA/i;

			$(window.document).bind("keydown keypress", function(e){
				if( e.which == 8 ){ // 8 == backspace
					if(!rx.test(e.target.tagName) || e.target.disabled || e.target.readOnly ){
						e.preventDefault();
					}
				}
			});
			
		})
		
					
	})
	</script>
</head>
<body>
<div id="top-wrapper"></div>
</body>
</html>
