<!DOCTYPE html>
<html>
<head>
  <link href="css/normalize.css" media="all" rel="stylesheet" type="text/css" />
  <link href="css/style.css" media="all" rel="stylesheet" type="text/css" />

  <link rel="stylesheet/less" href="css/style.less" type="text/css" /> 

  <link href="fonts/SourceSansPro/fontface.css" media="all" rel="stylesheet" type="text/css" />
  <link href="fonts/Meteocons/stylesheet.css" media="all" rel="stylesheet" type="text/css" />
  <!-- third party libraries should be loaded here and then passed to the Widgetizer module... -->
  <script type="text/javascript" src="js/less/less-1.6.1.min.js"></script>
  <script type="text/javascript" src="js/jquery/jquery-2.0.3.min.js"></script>
  <script type="text/javascript" src="js/jquery.svg/jquery.svg.min.js"></script>
  <script type="text/javascript" src="js/jquery.svg/jquery.svgdom.min.js"></script>
  <script type="text/javascript" src="js/svgjs/svg.min.js"></script>
  <script type="text/javascript" src="js/svgjs/svg.easing.min.js"></script>
  <script type="text/javascript" src="js/svgjs/svg.filter.js">
  </script>
  
  <style>
	html, body {
		overflow: auto;
	}
  </style>
  
	<script>
	var DEBUG = true
	
	// access main module...
	////process.mainModule.exports.hello()

	$(document).ready(function() {
	
		var fs = require('fs');
		var mustache = require('mustache');
		var url = require('url')
		var path = require('path')
		var gui = require('nw.gui');
		var Auth  = require("./lib/auth")(window)
		var Imports = require("./lib/dao/imports")
		var UserVideos = require("./lib/dao/uservideos")

		var url = require("url")
    	var parsedUrl = url.parse(window.location.href, true)
      	var page = parsedUrl.query.page || 1
		var userId = Auth.getLoggedUser().id
		var adminId = 123


		var i18n = new (require('i18n-2'))({
		    locales: ['en', 'de', 'cz'],
		    defaultLocale: 'en'
		});

		i18n.setLocale('de')

		var getImports = function(cb) {
			Imports.listNewest({adminId:adminId}, 10*(page-1), 10, cb)
		}

		var getVideos = function(cb) {
			UserVideos.listNewest({adminId:adminId}, 10*(page-1), 10, cb)
		}



		var showImports = function(data) {
			console.log(data)
			var root = $("#import-list").empty()
			if(data) {
				for(var i=0; i<data.length; i++) {
					root.append(showItem(data[i]))
				}
			}
		}

		var showVideos = function(data) {
			console.log(data)
			var root = $("#video-list").empty()
			if(data && data.items) {
				for(var i=0; i<data.items.length; i++) {
					root.append(showVideoItem(data.items[i]))
				}
			}
		}

		var showItem = function(item) {
			var previewUri = "assets/misc/nopreview.svg"
			if(item.preview) {
				var appBaseUri = "file://" + path.join(Storage.importDir, item.importName)			
				previewUri = appBaseUri + "/" + item.preview
			}
			var out = $("<div>").append(
				$("<h3>").text(item.title),
				$("<div>").text("Created: "+item.created),
				$("<img>").attr({
					"width":100,
					"height":100,
					"src": previewUri
				}).click(function() {
					window.location.href= "index.html?view=apppage&importname="+item.importName
				}),
				$("<button>").text("Remove").click(function() {
					showRemoveDialog(function() {
						// confirmed...
						removeItem(item._id.id, item.importName, out)
					})
				})
			)
			return out
		}

		var showVideoItem = function(item) {	
			var previewUri = "http://img.youtube.com/vi/"+item.id+"/default.jpg"
			/* strangely, this does not seem to work... */
			//var previewUri = item.thumbnail.sqDefault
			var out = $("<div>").append(
				$("<h3>").text(item.title || item.id),
				$("<img>").attr({
					"width":120,
					"height":90,
					"src": previewUri
				}).click(function() {
					window.location.href= "index.html?view=videopage&id="+item.videoId
				}),
				$("<button>").text("Remove").click(function() {
					showRemoveDialog(function() {
						// confirmed...
						removeVideoItem(userId, item.id, out)
					})
				})
			)
			return out
		}
		
		var removeItem = function(id, importName, div) {
			// remove record from database...
			Imports.remove(id, function(err, res) {
				if(err) console.error(err);
				else {
					console.log("Removing directory...")
					var dir = path.join(Storage.importDir, importName)
					// remove dir with its contents...
					fs.remove(dir, function(err) {
						if(err) console.error(err);
						else {
							console.log("Deleted successfully!")
							// TODO flash message
							//refreshImportsView()
							div.fadeOut("slow")
						}
						
					})
				}
			})
		}

		var removeVideoItem = function(userId, videoId, div) {
			// remove record from database...
			UserVideos.remove(adminId, userId, videoId, function(err, res) {
				if(err) console.error(err);
				else {
					console.log("Removing directory...")
					div.fadeOut("slow")
				}
			})
		}

		var fs = require("fs-extra")
		var unzip = require("unzip")
		var temp = require("temp")
		var Manifest =  require("./lib/manifest")
		var Storage = require("./lib/storage")
		var Hashids = require('hashids'),
		hashids = new Hashids('this is my salt', 8);
		
		// ensure that some directories exist...
		Storage.init()
		
function getExtension(filename) {
    var ext = path.extname(filename||'').split('.');
    return ext[ext.length - 1];
}
	var fileSelected = function(path, next) {
		if(getExtension(path) != "zip") {
			/* not archive ... */
			console.log("Must be a .zip archive")
			return
		}
		Manifest.loadFromArchive(path, function(err, res) {
			if(err) {
				/* manifest missing or invalid */
				console.log("Failed to load manifest file")
				console.error(err)
				// TODO show prompt with "are you sure?" and a form with default manifest 
				/* create default manifest and continue importing... */
				next(path, {})
			} else {
				/* manifest ok */
				console.log("Manifest loaded successfully.")
				console.log(res)
				next(path, res)
			}
		})
	}
												  
	var unpackArchive = function(path, dirPath, next) {
			fs.createReadStream(path)
				.pipe(unzip.Extract({ path: dirPath }))
				.on("close", next)
	}
				  
	var importArchive = function(path, m) {
		console.log("Importing archive from "+path)
		console.log("With manifest: ", m)
		temp.mkdir('wowimport', function(err, dirPath) {
			console.log("Created temporary directory "+dirPath)
			unpackArchive(path, dirPath, function(err) {
				if(err) {
					console.log("Archive unpacking failed")
					console.error(err)
					// TODO remove temporary directory
					// must set tracking for temp dir
					temp.cleanup()
				} else {
					console.log("Archive unpacked successfully!")
					finalizeImport(dirPath, m)
				}
			})
		});				
	}
	
	// when doing imports after the first, crud.create returns sometimes with empty ID
	// until fixed, the page should be refreshed after each import
	// or.. do not reuse the import form
	var finalizeImport = function(dirPath, m, copy) {
		console.log("App is unpacked and ready at "+dirPath)
		console.log("Preparing to import...")
		console.log("Manifest:", m)
		var data = m
		Imports.create(adminId, data, function(err, res) {
		if(!err) {
			console.log("Data inserted! ID="+res._id)
			console.log(res)
			var newName = hashids.encrypt(res._id.id)
			console.log(newName)
			var newPath = path.join(Storage.importDir, newName)
			var fun = function(err) {
				if(!err) {
					res.importName = newName
					// update entry in database...
					Imports.update(res, function(err, res2) {
						console.log("Import completed successfully.")
						console.log(res)		
						refreshImportsView()
						/* signal that import finished OK */
					})
				}
			}
			if(copy) 
				fs.copy(dirPath, newPath, fun); 
			else 
				fs.rename(dirPath, newPath, fun);
		}
		})
	}

	var importFromDirectory = function(dir) {
		// is it a directory?
		////window.alert(dir)
		// load manifest or create one...

		if (fs.existsSync(path.join(dir, "index.html"))) {
			// Do something
			////window.alert("Found index.html")
			var m = {}
			finalizeImport(dir, m, true)
		} else {
			window.alert("Index.html not found!")
		}
	}
	
	var youtube = require('youtube-feeds')

	var getVideoMetadata = function(videoId, cb) {
		youtube.video(videoId, function(err, data) {
			if(!err) {
				cb(data)
			} else {
				// data not found
				cb(null)
			}
		})

	}

	var addUserVideo = function() {
		var userId = $("#videouser-textfield").val()
		var videoId = $("#videoid-textfield").val()
		if(userId && videoId) {
			/* get metadata for video ID... */
			getVideoMetadata(videoId, function(data) {
				if(data) {
					UserVideos.add(adminId, userId, videoId, data.title, function(err, res) {
						console.log(res)
						refreshVideosView()
					})
				}				
			})
		}
	}
	
		var dialogs = require("./lib/dialogs")($, i18n)
	
	function showRemoveDialog(cb) {
		dialogs.removeDialog(function(reallyRemove) {
			if(reallyRemove) cb()
		})
	}


	var refreshImportsView = function() {
		getImports(function(err, data) {
			showImports(data)
		})					
	}

	var refreshVideosView = function() {
		getVideos(function(err, data) {
			showVideos(data)
		})					
	}

		var importPathAdded = function(p) {
			// get manifest from file...
			fileSelected(p, function(p, manifest) {
				console.log("Import path added: "+p)
				console.log("With manifest:",manifest)
				
				manifest.adminId = adminId
				manifest.originalPath = p
				manifest.originalName = path.basename(p, '.zip')
				importArchive(p, manifest)
			})
		}
					
		// initialization

		  var chooser = $('#fileDialog')
		  chooser.change(function(evt) {
		      importPathAdded($(this).val());
		  });
		  var chooser2 = $('#dirDialog')
		  chooser2.change(function(evt) {
		      importFromDirectory($(this).val());
		  });

		  $("#add-import-btn").click(function() {
		  	chooser.trigger("click")
		  })
		  
		  $("#add-import-dir-btn").click(function() {
		  	chooser2.trigger("click")
		  })

		  $("#add-video-btn").click(addUserVideo)
		  
		  refreshImportsView()
		  refreshVideosView()
	})
	</script>
</head>
<body>
<div class="admin">
<input style="display:none;" id="fileDialog" type="file" accept=".zip,application/zip" />
<input style="display:none;" id="dirDialog"  type="file" nwdirectory />
	
	<h1>Admin Page</h1>
	<div class="admin-nav">
		<a href="index.html">Back to login page</a>
	</div>
	<div class="admin-body">
		<div class="importapp panel">
			<h2>Import App</h2>
			<div class="panel-body">
				<div>
					<label>Import app packaged in .zip archive: <button id="add-import-btn">Import</button></label>
				</div>
				<div>
					<label>Import app from directory: <button id="add-import-dir-btn">Import</button></label>
				</div>
			</div>
		</div>
		<div class="importedapps panel">
			<h2>Imported Apps</h2>
			<ul class="panel-body" id="import-list">
			</ul>
		</div>
		<div class="addvideo panel">
			<h2>Add YouTube Video</h2>
			<div class="panel-body">
				<div>
					<label><span>YouTube VideoID: </span><input type="text" id="videoid-textfield"/></label>
				</div>
				<div>
					<label><span>UserID: </span><input type="text" disabled id="videouser-textfield" value="555"/></label>
				</div>
				<div class="buttons">
					<button id="add-video-btn">Add to list</button>
				</div>
			</div>
		</div>
		<div class="uservideos panel">
			<h2>User Videos</h2>
			<ul class="panel-body" id="video-list">
			</ul>
		</div>
	</div>
	</div>
</body>
</html>
