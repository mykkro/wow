<!DOCTYPE html>
<html>
<head>
  <!-- File autogenerated by craft {{datetime}} -->
  <title>{{title}}</title>
  <link href="/css/normalize.css" media="all" rel="stylesheet" type="text/css" />
  <link href="/css/style.css" media="all" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="/css/bundle.css" type="text/css" /> 
  <link rel="stylesheet" href="/css/style.css" />
  <script src="/js/wow-libs.js"></script>
  <script src="/js/MyTextAreaField.js"></script>
  <!-- script src="/js/MyJSONField.js" -->
   <script type="text/javascript" src="/js/jquery.ajaxfileupload.js"></script>
  <script type="text/javascript" src="/js/jquery.imagedrop.js"></script>
  <script type="text/javascript" src="/js/jquery.dropanything.js"></script>
   <script src="/js/bundle.js"></script>
  <script src="/js/craft.bundle.js"></script>
  <script src="/js/app.js"></script>
  
  <script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io.connect('http://localhost:9999');
  socket.on('news', function (data) {  
    console.log("SOCKET: ",data);
    socket.emit('my other event', { my: 'data' });
  });
</script>
  
<script>
var JsonUtils = require("JsonUtils")

var doAjax = function(method, uri, data, cb) {
  var opts = (method == "GET") 
    ? {
      url: uri,
      type: method,
      contentType: "application/json; charset=utf-8"
    }
    : {
      url: uri,
      type: method,
      data: JSON.stringify(data),
      dataType: 'json',
      contentType: "application/json; charset=utf-8"
    }
    $.ajax(opts).then(function(res) {
      console.log("Response from server:", res)
      if(!res.error) {
        cb(null, res.response)
      } else {
        cb(res.error)
      }
    })
}

var formSubmitted = function(type, action, control, value, next) {
  console.log("Form "+type+"."+action+" submitted!")
  console.log(value)
  if(action == "add") {
    var uri = "/api/"+type+"/new"
    var data = value
    doAjax('POST', uri, data, function(err, res) {
      if(!err) {
        console.log("Data received: ", res)
        if(next) next(res[0])
      }
    })
  } else if(action=="edit") {
    var id = $("#tabs-"+tabindexes[type]+"-edit input[name=itemid]").val()
    var uri = "/api/"+type+"/" + id
    var data = value
    doAjax('PUT', uri, data, function(err, res) {
      if(!err) {
        console.log("Data received: ", res)
       if(next) next($.extend({_id:id},data))
      }
    })
  }
}

var refreshListView = function() {
  if(currentIndex>0) {
    var main = $("#tabs-"+currentIndex+"-list")
    var div = main.find(".list")
    var uri = "/api/"+currentTab+"/search"
    doAjax('GET', uri, {}, function(err, res) {
      if(!err) console.log("Data received: ", res)
        div.html(displayItems(currentTab, res))
    })
  }
}

var removeItem = function(type, id) {
    var uri = "/api/"+type+"/" + id
    doAjax('DELETE', uri, {}, function(err, res) {
      if(!err) console.log("Data received: ", res)
        refreshListView()
    })
}

var viewItem = function(type, item) {
  var tabIndex = tabindexes[type]
  // show item view...
  var div = $("#tabs-"+tabIndex+"-view .content")
  console.log(item, div)
  div.html(JSON.stringify(item, null, 2))
  tabbers[tabIndex].show(5) // view tab
}

var editItem = function(type, item) {
  var tabIndex = tabindexes[type]
  var control = tabeditforms[tabIndex]
  control.form.setValue(item)
  var hidn = $("#tabs-"+tabIndex+'-edit input[name=itemid]')
  hidn.val(item._id)
  var div = $("#tabs-"+tabIndex+"-edit .content")
  console.log(item, div)
  tabbers[tabIndex].show(6) // edit tab
}

var displayItems = function(type, items) {
  var out = $("<div>")
  out.append($("<div>").text("Displaying items: "+items.length))
  _.each(items, function(it) {
    out.append(displayItem(type, it))
  })
  return out
}

var displayItem = function(type, item) {
  var out = $("<div>")
  out.append($("<span>").text("#"+item._id+" "+item.title))
  var viewLink = $("<a>").attr("href", "#").addClass("viewitem").text(" view ").click(function() {
    viewItem(type, item)
    return false
  })
  var editLink = $("<a>").attr("href", "#").addClass("edititem").text(" edit ").click(function() {
    editItem(type, item)
    return false
  })
  var removeLink = $("<a>").attr("href", "#").addClass("removeitem").text(" remove ").click(function() {
    removeItem(type, item._id)
    return false
  })
  out.append(viewLink, editLink, removeLink)
  return out
}

var tabInfo = [
  {{#tabs}}
  "{{name}}",
  {{/tabs}}
]

var tabbers = {}
var tabnames = {}
var tabindexes = {}
var tabeditforms = {}
var tabaddforms = {}

var currentTab = null
var currentIndex = null

$(document).ready(function() {
  console.log("Ready!")

  var tabber1 = new Yetii({
      id: 'tabs-container-1',
      active: 1,
      tabclass: 'ui-tabs-panel',
      callback: function(tabnumber) {
        if(tabnumber>=1) {
          var tabName = tabInfo[tabnumber-1]
          currentTab = tabName
          currentIndex = tabnumber
        }
      }
  });  

  $("a.disabled").click(function(e) {
    e.preventDefault();
  });

  $('#allpurpose-dropzone').dropAnything({
      dropped: function(data) {
          console.log("Dropped!", data)
      }
  })  

})
</script>
</head>
<body>
  <header>
    <h2>Craft testing page</h2>
  </header>
  <div id="content">
    <div id="tabs-container-1" class="ui-tabs">
      <ul id="tabs-container-1-nav" class="ui-tabs-nav">
        {{#tabs}}
        <li><a href="#tabs-{{index}}">{{title}}</a></li>
        {{/tabs}}
        <li><a href="#tabs-testing">Testing</a></li>
      </ul>
      {{#tabs}}
      <div id="tabs-{{index}}" class="ui-tabs-panel">
        <h2>{{title}}</h2>
        <div id="tabs-subcontainer-{{index}}-1" class="ui-tabs">
          <ul id="tabs-subcontainer-{{index}}-1-nav" class="ui-tabs-nav">
            <li><a href="#tabs-{{index}}-schema">Schema</a></li>
            <li><a href="#tabs-{{index}}-defaults">Defaults</a></li>
            <li><a href="#tabs-{{index}}-add">Add</a></li>
            <li><a href="#tabs-{{index}}-list">List</a></li>
            <li><a href="#tabs-{{index}}-view" class="disabled">View</a></li>
            <li><a href="#tabs-{{index}}-edit" class="disabled">Edit</a></li>
          </ul>
          <div id="tabs-{{index}}-schema" class="ui-subtabs-panel">
            <pre class="json-view">{{{schemaView}}}</pre>
          </div>
          <div id="tabs-{{index}}-defaults" class="ui-subtabs-panel">
            <pre class="json-view">{{{defaultsView}}}</pre>
          </div>
          <div id="tabs-{{index}}-add" class="ui-subtabs-panel">
            <div class="form"></div>
            <script>
            $(function() {              
              var entitySchema = {{{schema}}}
              var formParams = {{{formParams}}}
              var schema = formParams.schema || entitySchema
              var options = formParams.options || {}
              var data = {{{defaultData}}}
              var form = $("#tabs-{{index}}-add .form").alpaca({
                schema:schema, 
                options:options, 
                data:data,
                postRender: function(control) {
                  // console.log("postRender: ")
                  tabaddforms[{{index}}] = control              
                  $(control.container).find("[name=submit]").click(function() {
                    // clicked on submit button...
                    formSubmitted("{{name}}", "add", control, control.form.getValue(), function(rr) {
                      // show item's view
                      viewItem("{{name}}", rr)
                    })
                    return false;
                  })
                }
              })
            })
            </script>
          </div>
          <div id="tabs-{{index}}-list" class="ui-subtabs-panel">
            <button class="refresh">Refresh</button>
            <div class="list"></div>
          </div>
          <div id="tabs-{{index}}-view" class="ui-subtabs-panel">
            <a class="showlist" href="#tabs-{{index}}-list">show list</a>
            <div class="content"></div>
          </div>
          <div id="tabs-{{index}}-edit" class="ui-subtabs-panel">
            <a class="showlist" href="#tabs-{{index}}-list">show list</a>
            <input type="hidden" name="itemid"/>
            <div class="form"></div>
            <script>
            $(function() {              
              var entitySchema = {{{schema}}}
              var formParams = {{{formParams}}}
              var schema = formParams.schema || entitySchema
              var options = formParams.options || {}
              var data = {{{defaultData}}}
              var form = $("#tabs-{{index}}-edit .form").alpaca({
                schema:schema, 
                options:options, 
                data:data,
                postRender: function(control) {
                  // console.log("postRender: ")
                  tabeditforms[{{index}}] = control              
                  $(control.container).find("[name=submit]").click(function() {
                    // clicked on submit button...
                    formSubmitted("{{name}}", "edit", control, control.form.getValue(), function(rr) {
                      viewItem("{{name}}", rr)
                    })
                    return false;
                  })
                }
              })
              console.log(form)
            })
            </script>            
          </div>
        </div>
        <script>
        $(function() {              
          $("#tabs-{{index}} .refresh").click(refreshListView)
          $("#tabs-{{index}} .showlist").click(function() {
            // show list subtab...
            tabbers[{{index}}].show(4)
            return false
          })
        })
        </script>
      </div>
      <script>
      tabnames[{{index}}] = "{{name}}"
      tabindexes["{{name}}"] = {{index}}
      tabbers[{{index}}] = new Yetii({
          id: 'tabs-subcontainer-{{index}}-1',
          tabclass: 'ui-subtabs-panel',
          callback: function(tabnumber) {
            if(tabnumber == 4) {
              // list tab
              refreshListView()
            }
          }
      });  
      </script>
      {{/tabs}}
      <div id="tabs-testing" class="ui-tabs-panel">
        <h2>Testing</h2>
        <div id="testarea">
          <form method="post" action="" enctype="multipart/form-data">
            <label>File Input: <input type="file" name="file" id="demo1" /></label>
            <input type="text" name="uuid" id="upload-uuid"/>
            <div id="upload-thumb"></div>
            <a href="#" id="remove-upload">Remove</a>
          </form>
          <div id="allpurpose-dropzone" class="dropzone">
            Drop anything here
          </div>
          <iframe src="http://www.google.com/custom" width="600" height="300"/>
          <script type="text/javascript">

            $(document).ready(function() {
              var previousUUID = null
              $("#remove-upload").click(function() {
                if(previousUUID) {
                  console.log("Deleting "+previousUUID)
                  var opts = {
                    url: "/upload/"+previousUUID,
                    type: "DELETE",
                    contentType: "application/json; charset=utf-8"
                  }
                  $.ajax(opts).then(function(res) {
                    console.log("Response from server:", res)
                    if(!res.error) {
                      console.log("File deleted!")
                      previousUUID = null
                      $("#upload-thumb").empty()
                      $("#remove-upload").hide()
                      $("#upload-uuid").val(previousUUID)
                    } 
                  })                  
                  return false
                }
              }).hide()
              $("#demo1").AjaxFileUpload({
                action: previousUUID ? "/upload?uuid="+previousUUID : "/upload",
                onComplete: function(filename, response) {
                  console.log("Uploaded!", filename, response)
                  $("#upload-thumb").html(
                    $("<img />").attr("src", response.thumbnailUri).attr("width", 200)
                  );
                  previousUUID = response.uuid
                  $("#remove-upload").show()
                  $("#upload-uuid").val(previousUUID)
                },
                onSubmit : function(id, fileName){
                  // send additionsl data to be send in form submit...
                  return { uuid: previousUUID }
                }
              });
            });

          </script>
      </div>
    </div>
  </div>
  <footer>
  </footer>
</body>
</html>
