<!DOCTYPE html>
<html>
<head>
  <!-- File autogenerated by craft {{datetime}} -->
  <title>{{title}}</title>
  <link href="/css/normalize.css" media="all" rel="stylesheet" type="text/css" />
  <link href="/css/style.css" media="all" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="/css/bundle.css" type="text/css" /> 
  <script src="/js/wow-libs.js"></script>
  <script src="/js/MyTextAreaField.js"></script>
  <!-- script src="/js/MyJSONField.js" -->
  <script src="/js/bundle.js"></script>
  <script src="/js/craft.bundle.js"></script>
<script>
var JsonUtils = require("JsonUtils")

var doAjax = function(method, uri, data, cb) {
  var opts = (method == "GET") 
    ? {
      url: uri,
      type: method,
      contentType: "application/json; charset=utf-8"
    }
    : {
      url: uri,
      type: method,
      data: JSON.stringify(data),
      dataType: 'json',
      contentType: "application/json; charset=utf-8"
    }
    $.ajax(opts).then(function(res) {
      console.log("Response from server:", res)
      if(!res.error) {
        cb(null, res.response)
      } else {
        cb(res.error)
      }
    })
}

var formSubmitted = function(type, action, control, value) {
  console.log("Form "+type+"."+action+" submitted!")
  console.log(value)
  if(action == "add") {
    var uri = "/api/"+type+"/new"
    var data = value
    doAjax('POST', uri, data, function(err, res) {
      if(!err) console.log("Data received: ", res)
    })
  }
}

var refreshListView = function() {
  if(currentIndex>0) {
    var main = $("#tabs-"+currentIndex+"-list")
    var div = main.find(".list")
    var uri = "/api/"+currentTab+"/search"
    doAjax('GET', uri, {}, function(err, res) {
      if(!err) console.log("Data received: ", res)
        div.html(displayItems(currentTab, res))
    })
  }
}

var removeItem = function(type, id) {
    var uri = "/api/"+type+"/" + id
    doAjax('DELETE', uri, {}, function(err, res) {
      if(!err) console.log("Data received: ", res)
        refreshListView()
    })
}

var displayItems = function(type, items) {
  var out = $("<div>")
  out.append($("<div>").text("Displaying items: "+items.length))
  _.each(items, function(it) {
    out.append(displayItem(type, it))
  })
  return out
}

var displayItem = function(type, item) {
  var out = $("<div>")
  out.append($("<span>").text("#"+item._id+" "+item.title))
  var removeBtn = $("<button>").text("Remove")
  removeBtn.click(function() {
    removeItem(type, item._id)
  })
  out.append(removeBtn)
  return out
}

var tabInfo = [
  {{#tabs}}
  "{{name}}",
  {{/tabs}}
]

var currentTab = null
var currentIndex = null

$(document).ready(function() {
  console.log("Ready!")

  var tabber1 = new Yetii({
      id: 'tabs-container-1',
      active: 1,
      tabclass: 'ui-tabs-panel',
      callback: function(tabnumber) {
        if(tabnumber>=1) {
          var tabName = tabInfo[tabnumber-1]
          currentTab = tabName
          currentIndex = tabnumber
        }
      }
  });  

})
</script>
<style>
.ui-tabs {
  zoom: 1;
}
.ui-tabs .ui-tabs-nav {
  list-style: none;
  position: relative;
  padding: 0;
  margin: 0;
}
.ui-tabs .ui-tabs-nav li {
  position: relative;
  float: left;
  margin: 0 3px -2px 0;
  padding: 0;
}
.ui-tabs .ui-tabs-nav li a {
  display: block;
  padding: 10px 20px;
  background: #f0f0f0;
  border: 2px #ccc solid;
  border-bottom-color: #ccc;
  outline: none;
}
.ui-tabs .ui-tabs-nav li.ui-tabs-selected a {
  padding: 10px 20px 12px 20px;
  background: #fff;
  border-bottom-style: none;
}
.ui-tabs .ui-tabs-nav li.ui-tabs-selected a,
.ui-tabs .ui-tabs-nav li.ui-state-disabled a,
.ui-tabs .ui-tabs-nav li.ui-state-processing a {
  cursor: default;
}
.ui-tabs .ui-tabs-nav li a,
.ui-tabs.ui-tabs-collapsible .ui-tabs-nav li.ui-tabs-selected a {
  cursor: pointer;
}
.ui-tabs .ui-tabs-panel, 
.ui-tabs .ui-subtabs-panel {
  display: block;
  clear: both;
  border: 2px #ccc solid;
  padding: 10px;
}
.ui-tabs .ui-tabs-hide {
  display: none;
}
pre.json-view {
  outline: 1px solid #ccc; padding: 5px; margin: 5px; }
.string { color: green; }
.number { color: darkorange; }
.boolean { color: blue; }
.null { color: magenta; }
.key { color: red; }

html, body {
  overflow: auto;
}

</style>
</head>
<body>
  <header>
    <h2>Craft testing page</h2>
  </header>
  <div id="content">
    <div id="tabs-container-1" class="ui-tabs">
      <ul id="tabs-container-1-nav" class="ui-tabs-nav">
        {{#tabs}}
        <li><a href="#tabs-{{index}}">{{title}}</a></li>
        {{/tabs}}
      </ul>
      {{#tabs}}
      <div id="tabs-{{index}}" class="ui-tabs-panel">
        <h2>{{title}}</h2>
        <div id="tabs-subcontainer-{{index}}-1" class="ui-tabs">
          <ul id="tabs-subcontainer-{{index}}-1-nav" class="ui-tabs-nav">
            <li><a href="#tabs-{{index}}-schema">Schema</a></li>
            <li><a href="#tabs-{{index}}-defaults">Defaults</a></li>
            <li><a href="#tabs-{{index}}-add">Add</a></li>
            <li><a href="#tabs-{{index}}-list">List</a></li>
          </ul>
          <div id="tabs-{{index}}-schema" class="ui-subtabs-panel">
            <pre class="json-view">{{{schemaView}}}</pre>
          </div>
          <div id="tabs-{{index}}-defaults" class="ui-subtabs-panel">
            <pre class="json-view">{{{defaultsView}}}</pre>
          </div>
          <div id="tabs-{{index}}-add" class="ui-subtabs-panel">
            <div class="form"></div>
            <script>
            $(function() {              
              var entitySchema = {{{schema}}}
              var formParams = {{{formParams}}}
              var schema = formParams.schema || entitySchema
              var options = formParams.options || {}
              var data = {{{defaultData}}}
              var form = $("#tabs-{{index}}-add .form").alpaca({
                schema:schema, 
                options:options, 
                data:data,
                postRender: function(control) {
                  // console.log("postRender: ")
                  $(control.container).find("[name=submit]").click(function() {
                    // clicked on submit button...
                    formSubmitted("{{name}}", "add", control, control.form.getValue())
                    return false;
                  })
                }
              })
            })
            </script>
          </div>
          <div id="tabs-{{index}}-list" class="ui-subtabs-panel">
            <button class="refresh">Refresh</button>
            <div class="list"></div>
            <script>
            $(function() {              
              var btn = $("#tabs-{{index}}-list .refresh")
              btn.click(refreshListView)
            })
            </script>
          </div>
        </div>
      </div>
      <script>
      new Yetii({
          id: 'tabs-subcontainer-{{index}}-1',
          tabclass: 'ui-subtabs-panel',
          callback: function(tabnumber) {
            if(tabnumber == 4) {
              // list tab
              refreshListView()
            }
          }
      });  
      </script>
      {{/tabs}}
    </div>
  </div>
  <footer>
  </footer>
</body>
</html>
